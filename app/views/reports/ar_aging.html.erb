<%= content_for :css do %>
<style>
    #main #filter {
        height: 46px;
    }

    .flex {
        display: flex;
        align-items: center;
    }
</style>
<% end %>
<%= render "shared/header" %>

<div id="nav">
    <%= render "shared/nav" %>
</div>

<div id="main">

    <div id="content-full">
        <a class="print btn" href="javascript:print();"><i class="icon-print"></i> Print</a>
        <h1><%=Setting.find_by_name("Client Name").value%> / Umur Piutang Pelanggan: <span class="red"><%=Date::MONTHNAMES[@monthEnd.to_i]%> <%=@yearEnd%></span></h1>

        <br class="clearfix" />

        <div id="filter">
            <form id="filterform" name="filterform" action="" method="get">
                <div class="field-row continue flex">
                    <label for="customer_id" style="width: 72px;">Pelanggan</label>
                    <select name="customer_id" class="third left">
                        <option value="">Semua Pelanggan</option>
                        <% @customers.each do |customer| %>
                        <option value="<%=customer.id%>" <% if customer.id == @customer_id %> selected='selected' <% end %>><%=customer.name%></option>
                        <% end %>
                    </select>
                    <label for="date" class="middle" style="width: 64px;">Periode</label>
                    <select name="month" class="half left" style="margin-right:10px; width: 90px;">
                        <% (1.upto(12)).each do |m| %>
                        <option value="<%="%02d" % m.to_s%>" <% if "%02d" % m.to_s == @month %> selected='selected' <% end %>><%=Date::MONTHNAMES[m]%></option>
                        <% end %>
                    </select>
                    <% year_to = Taxinvoice.order(:date).first.date.year rescue nil || Date.today.year %>
                    <select name="year" class="short left" style="margin-right: 10px;">
                        <% (Date.today.year.downto(year_to)).each do |y| %>
                        <option value="<%=y%>" <% if y.to_s == @year %> selected='selected' <% end %>><%=y%></option>
                        <% end %>
                    </select>

                    <label for="date" class="middle" style="width: 64px;">Sampai</label>
                    <select name="monthEnd" class="half left" style="margin-right:10px; width: 90px;">
                        <% (1.upto(12)).each do |m| %>
                        <option value="<%="%02d" % m.to_s%>" <% if "%02d" % m.to_s == @monthEnd %> selected='selected' <% end %>><%=Date::MONTHNAMES[m]%></option>
                        <% end %>
                    </select>
                    <% year_to = Taxinvoice.order(:date).first.date.year rescue nil || Date.today.year %>
                    <select name="yearEnd" class="short left">
                        <% (Date.today.year.downto(year_to)).each do |y| %>
                        <option value="<%=y%>" <% if y.to_s == @yearEnd %> selected='selected' <% end %>><%=y%></option>
                        <% end %>
                    </select>
                    <input class="submit left" type="submit" value="Filter" />
                </div>

            </form>
        </div>

        <br class="clearfix" />

        <table class="row-view tablesorter tablesorterFilters">
            <thead>
                <tr>
                    <th class="{sorter:true, filter: true}">Pelanggan</th>
                    <th width="200" class="{sorter:true, filter: true}">Follow-Up</th>
                    <th width="80" class="center {sorter:true, filter: true}">Omzet</th>
                    <th width="80" class="center {sorter:true, filter: true}">Piutang</th>
                    <th width="80" class="center {sorter:true, filter: true}">Kontrol</th>
                    <th width="100" class="center {sorter:true, filter: true}">Cash in</th>
                    <th width="100" class="center {sorter:true, filter: true}">Umur Piutang</th>
                    <th width="100" class="center {sorter:true, filter: true}">Limit Piutang</th>
                    <th width="20" class="right {sorter:false, filter: false}"></th>
                </tr>
            </thead>
            <% i = 0 %>
            <% total = 0 %>
            <tbody>
                <% @customer_datas.each_with_index do |customer| %>
                <tr data-customer-id = "<%= customer[:customer_id] %>">
                    <td><%= customer[:name] %><br><span style="color: grey; font-size: 12px;"><%= customer[:city] %></span></td>
                    <td>
                    <% if customer[:customer_notes].present? %>
                    <ul id="notes-list-<%= customer[:customer_id] %>" style="padding-left: 15px; margin: 0; font-size: 12px; color: #555;">
                        <% customer[:customer_notes].each do |note| %>
                        <li id="note-<%= note[:id] %>">
                        <span>
                            <%= note[:description] %>&nbsp;
                            <%= link_to "✕", customernote_path(note[:id]),
                            method: :delete,
                            remote: true,
                            data: { confirm: "Hapus note ini?" },
                            style: "color: red; margin-left: 5px; font-weight: bold; text-decoration: none; position: absolute;" %>

                        </span>
                        <br>
                        <span style="color: grey; font-size: 10px;">
                            (<%= Time.parse(note[:created_at]).strftime("%Y-%m-%d %H:%M") %>)
                        </span>
                        </li>

                        <% end %>
                    </ul>
                    <br/>
                    <% else %>
                    
                    <ul id="notes-list-<%= customer[:customer_id] %>" style="padding-left: 15px; margin: 0; font-size: 12px; color: #555;">
                    </ul>
                    <br/>

                    <% end %>

                    <a href="#" style="font-size: 10px;
                        text-decoration: underline;
                        font-weight: 500;
                        color: darkslateblue;
                        padding-left: 14px;
                        padding-bottom: 6px;" class="add-note-btn" data-customer-id="<%= customer[:customer_id] %>">
                        Tambah data
                    </a>
                    </td>

                    <td class="right"><%= to_currency(customer[:total_omzet]) %></td>
                    <td class="right"><%= to_currency(customer[:total_piutang]) %></td>
                    <td class="right"><%= to_currency(customer[:kontrol_piutang]) %></td>
                    <td class="right"><%= to_currency(customer[:cashin]) %></td>
                    <td class="right"><%= customer[:umur_piutang] %> hari</td>
                    <td class="right"><%= to_currency(customer[:limit_piutang]) %></td>
                    <td class="">
                        <!--
                        <%= customer[:jumlah_bulan] %><br/>
                        <%= customer[:rata2_piutang] %><br/>
                        <%= customer[:rata2_omzet] %>
                        -->
                    </td>
                </tr>
                <% end %>
            </tbody>
            <tfoot>
                <tr>
                    <td></td>
                    <td></td>
                    <td class="right"><strong><%= to_currency(@grandtotal_omzet) %></strong></td>
                    <td class="right"><strong><%= to_currency(@grandtotal_piutang) %></strong></td>
                    <td></td>
                    <td class="right"><strong><%= to_currency(@grandtotal_cashin) %></strong></td>
                    <td class="right">
                        <strong class="<%= 'green' if (@grandtotal_cashin.to_f / @grandtotal_piutang.to_f) * 100 > 0 %> <%= 'red' if (@grandtotal_cashin.to_f / @grandtotal_piutang.to_f) * 100 < 0 %>">
                            <%= ((@grandtotal_cashin.to_f / @grandtotal_piutang.to_f) * 100).round %>
                            %
                        </strong>
                    </td>
                    <td></td>
                </tr>
            </tfoot>
        </table>

    </div>

</div>


<div id="note-modal" style="border-radius: 10px; display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); 
    background: #f0f0f0; border:1px solid #ccc; padding:20px; z-index:1000; width:420px;">
  <h3 style="margin: 0 0 12px; font-weight: bold;">Tambah Catatan</h3>
  
  <textarea id="note-text" name="customernote[description]" 
    style="width: 97%; height: 100px; min-width: 0;"></textarea>
  
  <br><br>
  <button id="save-note">Save</button>
  <button id="close-note">Cancel</button>
  <br>
</div>

<div id="modal-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:999;"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let currentCustomerId = null;

  const modal     = document.getElementById("note-modal");
  const overlay   = document.getElementById("modal-overlay");
  const noteField = document.getElementById("note-text");
  const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

  // --- buka modal ---
  document.querySelectorAll(".add-note-btn").forEach(btn => {
    btn.addEventListener("click", e => {
      e.preventDefault();
      currentCustomerId = btn.dataset.customerId;
      modal.style.display = "block";
      overlay.style.display = "block";
      noteField.value = "";
    });
  });

  // --- tutup modal ---
  document.getElementById("close-note").addEventListener("click", () => {
    modal.style.display = "none";
    overlay.style.display = "none";
  });

  // --- simpan note ---
  document.getElementById("save-note").addEventListener("click", () => {
    const description = noteField.value.trim();
    if (!description) return alert("Isi catatan dulu");

    fetch("/customernotes", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": csrfToken
      },
      body: JSON.stringify({
        customernote: {   // ✅ disesuaikan dengan controller
          customer_id: currentCustomerId,
          description: description
        }
      })
    })
    .then(r => r.json())
    .then(data => {
      if (!data.success) return alert("Gagal simpan data: " + (data.errors || []).join(", "));

      const list = document.getElementById(`notes-list-${currentCustomerId}`);
      if (list && list.querySelector("li")?.innerText.trim() === "-") list.innerHTML = "";

      // bikin element note baru
      const li = document.createElement("li");
      li.id = `note-${data.note.id}`;
      li.innerHTML = `
        ${data.note.description}
        <a href="#" class="delete-note-btn" data-note-id="${data.note.id}"
           style="color: red; margin-left: 5px; font-weight: bold; text-decoration: none; position: absolute;">✕</a>
        <br><span style="color: grey; font-size: 10px;">(${data.note.created_at})</span>
      `;
      if (list) list.prepend(li);

      modal.style.display = "none";
      overlay.style.display = "none";
    })
    .catch(err => {
      console.error(err);
      alert("Error simpan data");
    });
  });

  // --- hapus note (delegasi) ---
document.addEventListener("click", e => {
  const btn = e.target.closest(".delete-note-btn"); // ✅ lebih aman
  if (btn) {
    e.preventDefault();
    const noteId = btn.dataset.noteId;
    if (!confirm("Hapus catatan ini?")) return;

    fetch(`/customernotes/${noteId}`, {
      method: "DELETE",
      headers: {
        "X-CSRF-Token": csrfToken
      }
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        const noteEl = document.getElementById(`note-${noteId}`);
        if (noteEl) {
          noteEl.remove(); // ✅ langsung hapus dari DOM
        }
      } else {
        alert("Gagal hapus note");
      }
    })
    .catch(err => {
      console.error(err);
      alert("Error hapus note");
    });
  }
});

});
</script>


